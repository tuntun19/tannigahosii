<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>単位取得計算ツール</title>
  <link rel="stylesheet" href="style.css">
  <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }

        label,
        input,
        select,
        button {
            display: block;
            margin: 5px 0;
        }

        .result {
            margin-top: 20px;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
  <h1>単位取得計算ツール</h1>
  <div class="main">
    <label>試験ごとに割合は異なりますか？
      <select id="weightType" onchange="toggleWeightMode()">
        <option value="same">すべて同じ</option>
        <option value="different">異なる</option>
      </select>
    </label>

    <label>試験の回数: <input type="number" id="testCount" value="2" min="1" onchange="generateInputs()"></label>

    <div id="testInputs"></div>

    <h3>課題設定</h3>
    <label>課題の割合(%): <input type="number" id="assignmentWeight" value="30"></label>
    <label>課題の点数（空欄可）: <input type="number" id="assignmentScore" placeholder="未提出なら空欄 100点満点で記述"></label>

    <button onclick="calculate()">計算する</button>

    <div class="result" id="result"></div>
  </div>

  <script>
    function toggleWeightMode() {
      generateInputs();
    }

    function generateInputs() {
      const count = parseInt(document.getElementById("testCount").value);
      const mode = document.getElementById("weightType").value;
      const container = document.getElementById("testInputs");
      container.innerHTML = "<h3>試験設定</h3>";

      for (let i = 0; i < count; i++) {
        container.innerHTML += `
          ${mode === "different" ? `
            <label>試験${i + 1}の割合(%): <input type="number" class="testWeight" placeholder="例: 30"></label>
          ` : ""}
          <label>試験${i + 1}の点数（空欄 = 未受験）: <input type="number" class="testScore" placeholder="例: 70"></label>
          <hr>
        `;
      }

      if (mode === "same") {
        container.innerHTML = `
          <label>すべての試験の割合(%): <input type="number" id="sameWeight" placeholder="例: 70" value="70"></label>
        ` + container.innerHTML;
      }
    }

    generateInputs();

    function calculate() {
      const mode = document.getElementById("weightType").value;
      const testCount = parseInt(document.getElementById("testCount").value);
      let testWeights = [];
      let testScores = [];

      if (mode === "same") {
        const sameWeight = parseFloat(document.getElementById("sameWeight").value) || 0;
        for (let i = 0; i < testCount; i++) {
          testWeights.push(sameWeight / testCount);
        }
      } else {
        testWeights = Array.from(document.getElementsByClassName("testWeight")).map(el => parseFloat(el.value) || 0);
      }

      testScores = Array.from(document.getElementsByClassName("testScore")).map(el => el.value === "" ? null : parseFloat(el.value));

      const assignmentWeight = parseFloat(document.getElementById("assignmentWeight").value) || 0;
      const assignmentScoreInput = document.getElementById("assignmentScore").value;
      const hasAssignment = assignmentScoreInput !== "";
      const assignmentScore = hasAssignment ? parseFloat(assignmentScoreInput) : 0;

      let totalWeight = assignmentWeight;
      let achievedScore = hasAssignment ? (assignmentScore * assignmentWeight / 100) : 0;

      let missingTests = [];

      for (let i = 0; i < testCount; i++) {
        const weight = testWeights[i];
        const score = testScores[i];
        if (score === null) {
          missingTests.push({ index: i, weight });
        } else {
          achievedScore += score * weight / 100;
        }
        totalWeight += weight;
      }

      if (totalWeight > 100) {
        document.getElementById("result").innerHTML = `<p style="color:red;">⚠️ 試験と課題の割合の合計が ${totalWeight}% です。100%以内にしてください。</p>`;
        return;
      }

      function requiredScoreFor(target) {
        const required = target - achievedScore;
        const remainingWeight = missingTests.reduce((sum, t) => sum + t.weight, 0);

        if (remainingWeight === 0) {
          return required <= 0 ? "すでに達成済み" : `不可能（残り試験なし）`;
        }

        let requiredAvg = required * 100 / remainingWeight;
        if (requiredAvg > 100) return `不可能（必要平均 ${Math.ceil(requiredAvg)} 点）`;
        if (requiredAvg <= 0) return `すでに達成済み`;
        return `残り試験で平均 ${Math.ceil(requiredAvg)} 点以上必要`;
      }

      const levels = {
        "単位(可)（60点以上）": 60,
        "良（70点以上）": 70,
        "優（80点以上）": 80,
        "満点（100点）": 100
      };

      let resultHTML = `<h2>結果</h2><p>現在の加重得点: ${achievedScore.toFixed(2)} / ${totalWeight} 点</p><ul>`;
      for (const [label, value] of Object.entries(levels)) {
        const message = requiredScoreFor(value);
        resultHTML += `<li>${label}：${message}</li>`;
      }
      resultHTML += "</ul>";

      document.getElementById("result").innerHTML = resultHTML;
    }
  </script>
</body>
</html>
